<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    
    
    <link rel="manifest" href="manifest.json">
    
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
</head>
<body>
    
    <h1>HelloðŸ‘‹</h1>
    <h2>Thanks for using N2K.</h2>
    
    <p id="greeting"></p>
    
    <!-- Add a simpler button:
        Simple button that will open the modal.
    -->
    <!-- <button onclick="openNetlifyWidget()" id="loginbutton">Login</button> -->
    
    <button id="login-form" onclick="openNetlifyWidget()">Login / Logout</button>
    
    <pre id="version">v1.1</pre>
    <h2>Log : </h2>
    <pre id="log"></pre>
    
    
    <script>
        
        function openNetlifyWidget() {
            netlifyIdentity.open();
        }
        
        function greetUser(user){
            if (user == null){
                document.getElementById('greeting').innerHTML = "You're not logged in."
            } else {
                document.getElementById('greeting').innerHTML = "Welcome back, "+ user.user_metadata.full_name
                
            }
        }
        
        const user = netlifyIdentity.currentUser();
        console.log('current user :', user)
        greetUser(user)
        
        netlifyIdentity.on('init', user => {
            console.log('init. User :', user)
            //User is not logged in
            if (user == null) {
            }else {
                console.log('Welcome back, '+user);
                greetUser(user)
            }
        });
        
        netlifyIdentity.on('login', user => {
            console.log('Login succesfull for', user);
            greetUser(user)

        });

        netlifyIdentity.on('logout', user => {
            console.log('Logout');
            greetUser(user)
        })


        if( getSharedURLfromIntent() ) {
            if (user == null) {
                alert('You must be logged in to use to send.')
            } else {
                sendRequestToAWS(getSharedURLfromIntent());
            }

        }
        
        
        function getSharedURLfromIntent(){
            let parsedUrl = new URL(window.location.toString());
            console.log('Title shared: ' + parsedUrl.searchParams.get('title'));
            console.log('Text shared: ' + parsedUrl.searchParams.get('text'));
            document.getElementById("log").innerHTML += parsedUrl.searchParams.get('title')+ "\n";
            document.getElementById("log").innerHTML += parsedUrl.searchParams.get('text');

            return parsedUrl.searchParams.get('text');

        }
        
        
        function sendRequestToAWS(linkArticle) {
            
            var apiAWS = "https://bhn3zq0bak.execute-api.us-east-1.amazonaws.com/dev/sendtokindle?q="
            var xmlHttp = new XMLHttpRequest();
            
            xmlHttp.open("GET", apiAWS+linkArticle)
            console.log("request to "+apiAWS+linkArticle)
            if (linkArticle != null) {
                xmlHttp.send();
            }
            console.log("Response :", xmlHttp.response)
            
        }
        
        
        
        
        
        
        
        
    </script>
    
    <script>
        console.log("Hello world !")
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
        }
        
    </script>
</body>
</html>